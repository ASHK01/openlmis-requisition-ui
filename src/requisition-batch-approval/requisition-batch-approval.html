<h2>{{'requisitionBatchApproval.approveRequisitions' | message}}</h2>
<p class="alert is-error" ng-if="vm.areRequisitionsOutdated();">
    {{ 'requisitionBatchApproval.outdated' | message}}
    <button ng-click="vm.updateRequisitions();">{{ 'requisitionBatchApproval.update' | message }}</button>
</p>
<div class="openlmis-table-container">

    <saving-indicator class="requisition-indicator" object="vm.requisitions"/>
    <table>
        <thead>
        <tr>
            <th class="col-sticky is-hidden"></th>
            <th class="col-sticky is-hidden"></th>
            <th ng-repeat="requisition in vm.requisitions track by requisition.id"
                openlmis-invalid="{{'requisitionBatchApproval.invalidRequisition' | message}}"
                popover-trigger-area="element"
                colspan="2">
                {{requisition.facilityName}} - {{requisition.periodName}}
            </th>
            <th class="col-sticky sticky-right is-hidden"></th>
            <th class="col-sticky sticky-right is-hidden"></th>
        </tr>
        <tr>
            <th class="col-sticky">{{'requisitionBatchApproval.productCode' | message}}</th>
            <th class="col-sticky">{{'requisitionBatchApproval.product' | message}}</th>
            <th ng-repeat-start="requisition in vm.requisitions track by requisition.id">
                {{'requisitionBatchApproval.approvedQuantity' | message}}
            </th>
            <th ng-repeat-end>
                {{'requisitionBatchApproval.cost' | message}}
            </th>
            <th class="col-sticky sticky-right">
                {{'requisitionBatchApproval.totalQuantityForAllFacilities' | message}}
            </th>
            <th class="col-sticky sticky-right">
                {{'requisitionBatchApproval.totalCostForAllFacilities' | message}}
            </th>
        </tr>
        </thead>
        <tr ng-repeat="(productId, product) in vm.products track by productId">
            <td>{{product.code}}</td>
            <td class="requisition-product-grid-cell">
                <div class="collapsable">{{product.name}}</div>
            </td>
            <td ng-repeat-start="requisition in vm.requisitions track by requisition.id" class="numeric">
                <input ng-if="(product.requisitions | contains: requisition.id) && !(vm.lineItems[requisition.id][productId].skipped)"
                       positive-integer required
                       ng-model="vm.lineItems[requisition.id][productId].approvedQuantity"
                       ng-change="vm.updateLineItem(vm.lineItems[requisition.id][productId], requisition)"/>
                <p ng-if="vm.lineItems[requisition.id][productId].skipped">
                    {{'requisitionBatchApproval.skipped' | message}}
                </p>
            </td>
            <td class="numeric" ng-repeat-end>
                {{vm.lineItems[requisition.id][productId].totalCost | openlmisCurrency}}
            </td>
            <td class="total-cell numeric"> {{product.totalQuantity}} </td>
            <td class="total-cell numeric"> {{product.totalCost | openlmisCurrency}} </td>
        </tr>
        <tfoot>
            <tr class="total-row">
                <th class="col-sticky">{{'requisitionBatchApproval.total' | message}}</th>
                <th class="col-sticky"></th>
                <th ng-repeat-start="requisition in vm.requisitions track by requisition.id">
                </th>
                <th class="numeric" ng-repeat-end>
                    {{requisition.$totalCost | openlmisCurrency}}
                </th>
                <th></th>
                <th class="numeric"> {{vm.totalCost | openlmisCurrency}}</th>
            </tr>
        </tfoot>
    </table>
</div>
<div class="openlmis-toolbar button-group" ng-if="vm.requisitions.length">
    <button ng-disabled="vm.isOffline()" ng-click="vm.sync()">{{'requisitionBatchApproval.sync' | message}}</button>
    <div class="button-group primary">
        <button class="primary" ng-disabled="vm.isOffline()" ng-click="vm.approve()">{{'requisitionBatchApproval.approve' | message}}</button>
        <button class="danger" ng-click="vm.revert()">{{'requisitionBatchApproval.revert' | message}}</button>
    </div>
</div>
